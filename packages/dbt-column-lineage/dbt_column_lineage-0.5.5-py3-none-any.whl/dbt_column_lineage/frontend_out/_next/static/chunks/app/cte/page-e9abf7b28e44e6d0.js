(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[318],{79826:function(e,t,s){Promise.resolve().then(s.bind(s,86741))},86741:function(e,t,s){"use strict";s.d(t,{Cte:function(){return L}});var a=s(57437),n=s(16463),l=s(27289),r=s(2265),o=s(6785),c=s(63775),i=s(50197);s(10715);var d=s(37215),u=s(71165),h=s(20707),m=s(20548),x=s(37642),f=s(29820),b=s.n(f),p=s(92168),g=s(19997);let j=h.tk.theme({".cm-content":{fontFamily:"Roboto !important",fontSize:"smaller"}}),k=h.Py.define(),y=h.QQ.define({create:()=>h.p.none,update(e,t){for(let s of(e=e.map(t.changes),t.effects))s.is(k)&&(e=e.update({add:s.value,sort:!0}));return e},provide:e=>h.tk.decorations.from(e)}),v=(e,t,s)=>{let a=new(b()).graphlib.Graph().setDefaultEdgeLabel(()=>({}));return a.setGraph({rankdir:s}),t.forEach(e=>a.setEdge(e.source,e.target)),e.forEach(e=>a.setNode(e.id,{label:e.id,width:150,height:40})),b().layout(a),e.forEach(e=>{let t=a.node(e.id);switch(s){case"TB":e.targetPosition=o.Ly.Top,e.sourcePosition=o.Ly.Bottom;break;case"BT":e.targetPosition=o.Ly.Bottom,e.sourcePosition=o.Ly.Top;break;case"LR":e.targetPosition=o.Ly.Left,e.sourcePosition=o.Ly.Right;break;case"RL":e.targetPosition=o.Ly.Right,e.sourcePosition=o.Ly.Left}return e.position={x:t.x-75,y:t.y-20},e}),{nodes:e,edges:t}},w=e=>{let{columns:t}=e;return(0,a.jsxs)("table",{className:"table-auto text-xs w-full",children:[(0,a.jsx)("thead",{className:"sticky top-0 z-10",children:(0,a.jsxs)("tr",{className:"bg-gray-200",children:[(0,a.jsx)("th",{className:"border",children:"Column"}),(0,a.jsx)("th",{className:"border",children:"Type"}),(0,a.jsx)("th",{className:"border",children:"Description"})]})}),(0,a.jsx)("tbody",{children:Object.keys(t).map((e,s)=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"border",children:t[e].name.toLowerCase()}),(0,a.jsx)("td",{className:"border",children:t[e].type}),(0,a.jsx)("td",{className:"border",children:t[e].comment})]},s))})]})};function N(e,t){let s=new m.FH(e.state.doc,t);return(s.next(),0==s.value.from)?null:s.value}let C=e=>{let{nodes:t,edges:s,setNodes:l,setEdges:d,nodesPositioned:m,setNodesPositioned:x,codeMirrorRef:f,lineageTableColumns:b}=e,p=(0,r.useRef)(!0),{fitView:g}=(0,o._K)(),j=(0,n.useRouter)(),y=(0,n.useSearchParams)(),[w,C]=(0,r.useState)(!1),[L,P]=(0,r.useState)(!1),R=(0,u.o)(e=>e.options),S=(0,u.o)(e=>e.setOptions),E=(0,r.useCallback)(async e=>{S({rankdir:e}),x(!1)},[y]),T=(0,r.useCallback)((e,t,s)=>{let a=new URLSearchParams({schema:e,source:t});s&&a.set("column",s),j.push("/cte?".concat(a.toString()))},[y]),_=(0,r.useCallback)(e=>{if(null==f.current||null==f.current.view)return;if(null!=e.data.db){T(e.data.db,e.data.table,e.data.column);return}let t=f.current.view,s=N(t,"".concat(e.data.label," as ("));s&&(null==t||t.dispatch({selection:{head:s.from,anchor:s.to},scrollIntoView:!0,effects:h.tk.scrollIntoView(s.from,{x:"start",y:"start"})}))},[y]),B=(0,r.useCallback)(e=>t=>(("input"===t.type||t.has_db)&&(t.hidden=e),t),[]),F=(0,r.useCallback)(e=>{P(e),x(!1)},[]),D=(0,r.useCallback)(()=>{if(0==t.length||m)return;let e=v(t,s,R.rankdir);l([...e.nodes].map(B(L))),d([...e.edges].map(B(L))),window.requestAnimationFrame(()=>{setTimeout(()=>g(),0)}),C(!0),x(!0)},[m]),O=(0,r.useCallback)(e=>l(t=>(0,o.Fb)(e,t)),[l]),Z=(0,r.useCallback)(e=>d(t=>(0,o.yn)(e,t)),[d]),z=(0,r.useCallback)(e=>d(t=>(0,o.Z_)(e,t)),[d]);return(0,r.useEffect)(()=>{if(0==t.length||m||null==f.current||null==f.current.view)return;let e=[],s=h.p.mark({class:"bg-yellow-200"});for(let t in b){let a=b[t];for(let t of a.columns){let n="".concat(a.alias,".").concat(t)||"",l=N(f.current.view,n);l&&e.push(s.range(l.from,l.to))}let n="".concat(a.db,".").concat(t)||"",l=N(f.current.view,n);l&&e.push(s.range(l.from,l.to))}f.current.view.dispatch({effects:k.of(e)})},[m,f.current]),(0,r.useEffect)(()=>{p.current||D()},[m]),(0,r.useEffect)(()=>{S({rankdir:"TB"}),p.current=!1},[]),(0,a.jsx)(r.Suspense,{children:(0,a.jsxs)(o.x$,{nodes:t,edges:s,onNodesChange:O,onEdgesChange:Z,onConnect:z,onNodeClick:(e,t)=>_(t),children:[(0,a.jsxs)(o.s_,{position:"top-right",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("select",{value:R.rankdir,onChange:e=>E(e.target.value),children:[(0,a.jsx)("option",{value:"LR",children:"Left - Right"}),(0,a.jsx)("option",{value:"RL",children:"Right - Left"}),(0,a.jsx)("option",{value:"TB",children:"Top - Bottom"}),(0,a.jsx)("option",{value:"BT",children:"Bottom - Top"})]})}),(0,a.jsx)("div",{children:(0,a.jsxs)("label",{htmlFor:"ishidden",children:[(0,a.jsx)("input",{id:"ishidden",type:"checkbox",checked:L,onChange:e=>F(e.target.checked)}),"Hide source table"]})})]}),(0,a.jsx)(c.Z,{}),(0,a.jsx)(i.A,{style:{backgroundColor:"#f5f5f5"}})]})})},L=()=>{let{height:e,width:t}=(0,l.Y)(),[s,c]=(0,o.Rr)([]),[i,u]=(0,o.ll)([]),[m,f]=(0,r.useState)(!0),b=(0,r.useRef)(null),[k,v]=(0,r.useState)("lineage"),[N,L]=(0,r.useState)(""),[P,R]=(0,r.useState)(""),[S,E]=(0,r.useState)(""),[T,_]=(0,r.useState)(""),[B,F]=(0,r.useState)([]),[D,O]=(0,r.useState)({}),Z=(0,n.useRouter)(),z=(0,r.useCallback)(async e=>{let{sources:t,columns:s}=e;c([]),u([]);let a=t[0],n=s[a]?s[a][0]:"",l=new URLSearchParams({source:a,column:n}),r=await fetch("".concat("","/api/v1/cte?").concat(l)),o=await r.json();return 200!=r.status?(alert(o.error),Z.back(),!1):(c(o.nodes),u(o.edges),L(o.table_name),R(o.materialized),E(o.query),_(o.description),F(o.columns),O(o.lineage_table_columns),f(!1),U(),!0)},[Z]),U=(0,r.useCallback)(()=>{v("lineage"),setTimeout(()=>f(!1),100)},[v,f]);return(0,a.jsxs)("div",{children:[(0,a.jsx)(d.h,{handleFetchData:z}),(0,a.jsxs)("div",{className:"flex flex-wrap",children:[(0,a.jsxs)("div",{className:"w-1/2",children:[(0,a.jsxs)("h4",{className:"px-1 text-2xl font-bold flex items-center",children:[(0,a.jsx)("span",{className:"select-text",children:N}),(0,a.jsx)("small",{className:"ms-2 font-semibold text-gray-500 dark:text-gray-400 select-text",children:P})]}),(0,a.jsx)("div",{className:"px-2",style:{height:.85*e,overflowY:"auto"},children:(0,a.jsx)(h.ZP,{ref:b,value:S,theme:j,extensions:[(0,x.i6)(),y]})})]}),(0,a.jsxs)("div",{className:"w-1/2",style:{height:e-55-24},children:[(0,a.jsxs)("div",{className:"mx-2",children:[(0,a.jsx)("button",{className:"px-1 "+("description"==k&&"font-semibold"),onClick:()=>v("description"),children:"Description"}),(0,a.jsx)("button",{className:"px-1 "+("columns"==k&&"font-semibold"),onClick:()=>v("columns"),children:"Columns"}),(0,a.jsx)("button",{className:"px-1 "+("lineage"==k&&"font-semibold"),onClick:()=>U(),children:"Lineage"})]}),"description"==k&&(0,a.jsx)(p.U,{className:"markdown",remarkPlugins:[g.Z],children:T}),"columns"==k&&(0,a.jsx)(w,{columns:B}),"lineage"==k&&(0,a.jsx)(o.tV,{children:(0,a.jsx)(C,{nodes:s,edges:i,setNodes:c,setEdges:u,codeMirrorRef:b,nodesPositioned:m,setNodesPositioned:f,lineageTableColumns:D})})]})]})]})}}},function(e){e.O(0,[489,676,780,401,385,985,49,971,23,744],function(){return e(e.s=79826)}),_N_E=e.O()}]);