image: python:3.12-slim

include:
- project: 'public-corner/skillcorner-CICD'
  ref: feat/uv_migrate
  file: '.skillcorner-ci-common.yml'

stages:
  - test
  - build_and_publish
  - prepare_release
  - release


ruff:
  stage: test
  tags: [aws-fargate-runner]
  extends: .ruff

test:
  tags: [aws-fargate-runner]
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11"]
  variables:
    UV_PYTHON: ${PYTHON_VERSION}
  before_script:
    - !reference [.init_uv_with_venv]
    - uv sync
    - uv pip install external_dependencies && apt update && uv run external_dependencies apt
  extends: .uv_test_with_coverage


package:gitlab:
  stage: build_and_publish
  tags: [aws-fargate-runner]
  extends: .uv_build_and_publish

package:pypi:
  stage: build_and_publish
  tags: [aws-fargate-runner]
  before_script:
    - !reference [.init_uv]
  script:
    - uv build
    - uvx twine upload dist/*
  rules:
    - !reference [.default_release_rules, rules]


prepare_job:
  stage: prepare_release
  tags: [aws-fargate-runner]
  extends: .gitlab_release_prepare


release_job:
  stage: release
  tags: [aws-fargate-runner]
  extends: .gitlab_release_job

pages:  # has to be named pages to be deployed in Gitlab Pages
  stage: release
  tags: [aws-fargate-runner]
  script:
    - mkdir -p public/coverage/
    - mv htmlcov/* public/coverage/
  artifacts:
    paths:
      - public/coverage/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
