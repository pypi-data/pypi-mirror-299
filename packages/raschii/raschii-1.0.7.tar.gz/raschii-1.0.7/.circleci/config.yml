version: 2

jobs:
  install-and-test:
    docker:
      - image: ubuntu:22.04
    steps:
      - checkout
      - run:
          name: Install apt test dependencies
          command: |
            apt update
            apt install -y python3 python3-dev python3-wheel python3-pip
            apt install -y cmake g++ wget curl
      - run:
          name: Install pip test dependencies
          command: pip3 install pip pytest flake8 --upgrade
      - run:
          name: Install pybind11 (for testing generated C++ code)
          command: |
              pip3 install "pybind11[global]"
      - run:
          name: Install Raschii with its dependencies
          command: |
              pip3 install .
      - run:
          name: Run unit tests with system Python
          environment:
            # For some reason we need to set the number of cores for OpenBLAS,
            # otherwise numpy.linalg.solve hangs forever on some inputs. Maybe
            # a bug in the CircleCI virtual machine / OpenBLAS CPUID interaction?
            OPENBLAS_NUM_THREADS: 1
          command: python3 -m pytest -v tests/ --junitxml=~/reports/pytest/py3.xml --durations=10
      - store_test_results:
          path: ~/reports
      - store_artifacts:
          path: ~/reports

      - run:
          name: Run unit tests with latest Python from uv
          command: |
            # Install uv
            curl -LsSf https://astral.sh/uv/install.sh | sh
            source $HOME/.cargo/env
            
            # Create virtual env with latest Python
            uv python install cpython
            uv sync --python cpython
            
            # Run pytest in the virtual env with the uv Python
            uv run pytest -v tests/ --durations=10

workflows:
  version: 2
  on-commit: # Runs on every commit
    jobs:
      - install-and-test
  scheduled: # Runs every Saturday morning at 08:00 UTC
    triggers:
      - schedule:
          cron: "0 8 * * 6"
          filters:
            branches:
              only:
                - master
    jobs:
      - install-and-test
