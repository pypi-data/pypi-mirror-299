name: Run Script on Commit

on:
  push:
    branches:
      - dev  # Change this to the branch you want to track commits on

permissions:
  contents: write  # This allows the workflow to push changes

jobs:
  run-script:
    if: "!contains(github.event.head_commit.message, 'Update changelog on release')"  # Skip if this commit is from the workflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history so we can access all commit logs

      - name: Change to repository root
        run: cd ${{ github.workspace }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'  # Specify your desired Python version

      - name: Install dependencies for OpenAI script
        run: pip install openai python-dotenv

      - name: Get the current version and run Python script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}  # Pass the secret as an environment variable
        run: |

          python scripts/processing_git_log.py

      - name: Configure git for committing
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Stage the changelog file
        run: git add CHANGELOG.md

      - name: Commit the updated changelog
        run: git commit -m "Update changelog on release"

      - name: Push changes back to the repository
        run: git push origin ${{ github.ref }}
        

